from __future__ import annotations
import sys
from importlib.machinery import ModuleSpec, PathFinder
from importlib.machinery import all_suffixes as module_suffixes
from importlib.util import spec_from_file_location
from itertools import chain
from pathlib import Path

MAPPING: dict[str, str] = {'assets.src': '/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/assets/src', 'django_ledger': '/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger', 'docs.source.assets': '/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/docs/source/assets', 'docs.source.ntemplates': '/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/docs/source/ntemplates', 'screenshots': '/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/screenshots'}
NAMESPACES: dict[str, list[str]] = {'screenshots': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/screenshots'], 'django_ledger.static': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/static'], 'django_ledger.templates': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates'], 'django_ledger.tests.bdd.features': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/tests/bdd/features'], 'django_ledger.tests.bdd.features.steps': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/tests/bdd/features/steps'], 'django_ledger.tests.test_io_ofx.samples': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/tests/test_io_ofx/samples'], 'django_ledger.contrib.django_ledger_graphene.transaction': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/transaction'], 'django_ledger.contrib.django_ledger_graphene.unit': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/unit'], 'django_ledger.contrib.django_ledger_graphene.ledger': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/ledger'], 'django_ledger.contrib.django_ledger_graphene.bill': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/bill'], 'django_ledger.contrib.django_ledger_graphene.auth': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/auth'], 'django_ledger.contrib.django_ledger_graphene.entity': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/entity'], 'django_ledger.contrib.django_ledger_graphene.coa': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/coa'], 'django_ledger.contrib.django_ledger_graphene.purchase_order': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/purchase_order'], 'django_ledger.contrib.django_ledger_graphene.accounts': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/accounts'], 'django_ledger.contrib.django_ledger_graphene.http': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/http'], 'django_ledger.contrib.django_ledger_graphene.item': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/item'], 'django_ledger.contrib.django_ledger_graphene.bank_account': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/bank_account'], 'django_ledger.contrib.django_ledger_graphene.examples': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/examples'], 'django_ledger.contrib.django_ledger_graphene.data_import': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/data_import'], 'django_ledger.contrib.django_ledger_graphene.journal_entry': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/journal_entry'], 'django_ledger.contrib.django_ledger_graphene.vendor': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/vendor'], 'django_ledger.contrib.django_ledger_graphene.examples.entity': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/contrib/django_ledger_graphene/examples/entity'], 'django_ledger.static.django_ledger': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/static/django_ledger'], 'django_ledger.static.django_ledger.bundle': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/static/django_ledger/bundle'], 'django_ledger.static.django_ledger.img': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/static/django_ledger/img'], 'django_ledger.static.django_ledger.logo': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/static/django_ledger/logo'], 'django_ledger.static.django_ledger.logo_2': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/static/django_ledger/logo_2'], 'django_ledger.templates.django_ledger': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger'], 'django_ledger.templates.django_ledger.closing_entry': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/closing_entry'], 'django_ledger.templates.django_ledger.expense': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/expense'], 'django_ledger.templates.django_ledger.unit': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/unit'], 'django_ledger.templates.django_ledger.ledger': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/ledger'], 'django_ledger.templates.django_ledger.auth': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/auth'], 'django_ledger.templates.django_ledger.entity': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/entity'], 'django_ledger.templates.django_ledger.financial_statements': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/financial_statements'], 'django_ledger.templates.django_ledger.includes': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/includes'], 'django_ledger.templates.django_ledger.chart_of_accounts': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/chart_of_accounts'], 'django_ledger.templates.django_ledger.product': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/product'], 'django_ledger.templates.django_ledger.purchase_order': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/purchase_order'], 'django_ledger.templates.django_ledger.components': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/components'], 'django_ledger.templates.django_ledger.transactions': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/transactions'], 'django_ledger.templates.django_ledger.bills': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/bills'], 'django_ledger.templates.django_ledger.layouts': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/layouts'], 'django_ledger.templates.django_ledger.bank_account': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/bank_account'], 'django_ledger.templates.django_ledger.inventory': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/inventory'], 'django_ledger.templates.django_ledger.data_import': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/data_import'], 'django_ledger.templates.django_ledger.estimate': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/estimate'], 'django_ledger.templates.django_ledger.account': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/account'], 'django_ledger.templates.django_ledger.service': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/service'], 'django_ledger.templates.django_ledger.journal_entry': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/journal_entry'], 'django_ledger.templates.django_ledger.uom': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/uom'], 'django_ledger.templates.django_ledger.customer': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/customer'], 'django_ledger.templates.django_ledger.vendor': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/vendor'], 'django_ledger.templates.django_ledger.invoice': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/invoice'], 'django_ledger.templates.django_ledger.closing_entry.includes': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/closing_entry/includes'], 'django_ledger.templates.django_ledger.closing_entry.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/closing_entry/tags'], 'django_ledger.templates.django_ledger.expense.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/expense/tags'], 'django_ledger.templates.django_ledger.ledger.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/ledger/tags'], 'django_ledger.templates.django_ledger.entity.includes': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/entity/includes'], 'django_ledger.templates.django_ledger.financial_statements.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/financial_statements/tags'], 'django_ledger.templates.django_ledger.chart_of_accounts.includes': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/chart_of_accounts/includes'], 'django_ledger.templates.django_ledger.product.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/product/tags'], 'django_ledger.templates.django_ledger.purchase_order.includes': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/purchase_order/includes'], 'django_ledger.templates.django_ledger.purchase_order.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/purchase_order/tags'], 'django_ledger.templates.django_ledger.transactions.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/transactions/tags'], 'django_ledger.templates.django_ledger.bills.includes': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/bills/includes'], 'django_ledger.templates.django_ledger.bills.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/bills/tags'], 'django_ledger.templates.django_ledger.bank_account.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/bank_account/tags'], 'django_ledger.templates.django_ledger.inventory.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/inventory/tags'], 'django_ledger.templates.django_ledger.data_import.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/data_import/tags'], 'django_ledger.templates.django_ledger.estimate.includes': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/estimate/includes'], 'django_ledger.templates.django_ledger.estimate.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/estimate/tags'], 'django_ledger.templates.django_ledger.account.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/account/tags'], 'django_ledger.templates.django_ledger.service.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/service/tags'], 'django_ledger.templates.django_ledger.journal_entry.includes': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/journal_entry/includes'], 'django_ledger.templates.django_ledger.journal_entry.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/journal_entry/tags'], 'django_ledger.templates.django_ledger.uom.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/uom/tags'], 'django_ledger.templates.django_ledger.customer.includes': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/customer/includes'], 'django_ledger.templates.django_ledger.customer.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/customer/tags'], 'django_ledger.templates.django_ledger.vendor.includes': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/vendor/includes'], 'django_ledger.templates.django_ledger.vendor.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/vendor/tags'], 'django_ledger.templates.django_ledger.invoice.includes': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/invoice/includes'], 'django_ledger.templates.django_ledger.invoice.tags': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/django_ledger/templates/django_ledger/invoice/tags'], 'docs.source.assets': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/docs/source/assets'], 'docs.source.ntemplates': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/docs/source/ntemplates'], 'docs.source.assets.img': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/docs/source/assets/img'], 'docs.source.ntemplates.django_ledger': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/docs/source/ntemplates/django_ledger'], 'docs.source.ntemplates.django_ledger.purchase_order': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/docs/source/ntemplates/django_ledger/purchase_order'], 'assets.src': ['/Users/macbook/Documents/SaaS/flowingaccounts/django-ledger/assets/src'], 'assets': [], 'docs.source': [], 'docs': []}
PATH_PLACEHOLDER = '__editable__.django_ledger-0.7.7.finder' + ".__path_hook__"


class _EditableFinder:  # MetaPathFinder
    @classmethod
    def find_spec(cls, fullname: str, path=None, target=None) -> ModuleSpec | None:  # type: ignore
        # Top-level packages and modules (we know these exist in the FS)
        if fullname in MAPPING:
            pkg_path = MAPPING[fullname]
            return cls._find_spec(fullname, Path(pkg_path))

        # Handle immediate children modules (required for namespaces to work)
        # To avoid problems with case sensitivity in the file system we delegate
        # to the importlib.machinery implementation.
        parent, _, child = fullname.rpartition(".")
        if parent and parent in MAPPING:
            return PathFinder.find_spec(fullname, path=[MAPPING[parent]])

        # Other levels of nesting should be handled automatically by importlib
        # using the parent path.
        return None

    @classmethod
    def _find_spec(cls, fullname: str, candidate_path: Path) -> ModuleSpec | None:
        init = candidate_path / "__init__.py"
        candidates = (candidate_path.with_suffix(x) for x in module_suffixes())
        for candidate in chain([init], candidates):
            if candidate.exists():
                return spec_from_file_location(fullname, candidate)
        return None


class _EditableNamespaceFinder:  # PathEntryFinder
    @classmethod
    def _path_hook(cls, path) -> type[_EditableNamespaceFinder]:
        if path == PATH_PLACEHOLDER:
            return cls
        raise ImportError

    @classmethod
    def _paths(cls, fullname: str) -> list[str]:
        paths = NAMESPACES[fullname]
        if not paths and fullname in MAPPING:
            paths = [MAPPING[fullname]]
        # Always add placeholder, for 2 reasons:
        # 1. __path__ cannot be empty for the spec to be considered namespace.
        # 2. In the case of nested namespaces, we need to force
        #    import machinery to query _EditableNamespaceFinder again.
        return [*paths, PATH_PLACEHOLDER]

    @classmethod
    def find_spec(cls, fullname: str, target=None) -> ModuleSpec | None:  # type: ignore
        if fullname in NAMESPACES:
            spec = ModuleSpec(fullname, None, is_package=True)
            spec.submodule_search_locations = cls._paths(fullname)
            return spec
        return None

    @classmethod
    def find_module(cls, _fullname) -> None:
        return None


def install():
    if not any(finder == _EditableFinder for finder in sys.meta_path):
        sys.meta_path.append(_EditableFinder)

    if not NAMESPACES:
        return

    if not any(hook == _EditableNamespaceFinder._path_hook for hook in sys.path_hooks):
        # PathEntryFinder is needed to create NamespaceSpec without private APIS
        sys.path_hooks.append(_EditableNamespaceFinder._path_hook)
    if PATH_PLACEHOLDER not in sys.path:
        sys.path.append(PATH_PLACEHOLDER)  # Used just to trigger the path hook
